<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hợp Đồng Dịch Vụ - Kool D. Studio Premium</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;500;600&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-green: #3A5A40;
            --soft-gold: #eb9500;
            --cream: #194420;
            --light-gray: #E5E5E5;
            --charcoal: #333333;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--cream);
            color: var(--charcoal);
            padding: 2rem 1.5rem; /* Increased padding */
            font-size: 15px; /* Slightly increased base font size */
            line-height: 1.7; /* Increased line-height for better readability */
            -webkit-font-smoothing: antialiased;
        }

        .page-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .container {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(26, 61, 46, 0.08);
        }

        #contract-content {
            padding: 2.5rem 3rem; /* Increased padding */
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 2.5rem; /* Increased margin */
        }

        .studio-name {
            font-family: 'Playfair Display', serif;
            font-size: 26px; /* Slightly increased font size */
            font-weight: 700;
            color: var(--deep-green);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .tagline {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            font-size: 13px; /* Slightly increased font size */
            color: #777;
            letter-spacing: 0.08em;
            font-style: normal;
            margin-bottom: 1.2rem;
        }

        .gold-divider {
            width: 80px; /* Slightly wider */
            height: 1px;
            background: linear-gradient(to right, transparent, var(--soft-gold), transparent);
            margin: 0 auto 1.2rem; /* Adjusted margin */
        }

        .contract-meta {
            font-size: 12px; /* Slightly increased font size */
            color: #888;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* SECTION TITLE */
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 20px; /* Increased font size for prominence */
            font-weight: 700;
            color: var(--deep-green);
            margin-bottom: 1.2rem; /* Adjusted margin */
            padding-left: 1.4rem; /* Adjusted padding */
            position: relative;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 1.7em; /* Slightly increased height */
            background-color: var(--soft-gold);
            border-radius: 2px;
        }

        /* TWO COLUMN */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem; /* Increased gap */
            align-items: start;
        }

        /* INPUT CARD */
        .input-card {
            background: #fdfdfb;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 0.8rem 1rem; /* Increased padding */
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(212, 185, 142, 0.06);
            margin-bottom: 1rem; /* Increased margin */
        }

        .input-card:focus-within {
            border-color: var(--soft-gold);
            box-shadow: 0 4px 16px rgba(212, 185, 142, 0.15);
        }

        .input-card label {
            display: block;
            font-weight: 500;
            font-size: 13px; /* Slightly increased font size */
            color: var(--charcoal);
            margin-bottom: 0.5rem; /* Adjusted margin */
            letter-spacing: 0.03em;
        }

        .input-card input,
        .input-card textarea,
        .input-card select {
            width: 100%;
            border: none;
            background: transparent;
            font-family: 'Montserrat', sans-serif;
            font-size: 15px; /* Increased font size */
            color: var(--charcoal);
            resize: none;
            overflow: hidden;
        }

        .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-card textarea {
            min-height: 24px; /* Increased min-height */
            line-height: 1.6; /* Adjusted line-height */
        }

        .input-card input:focus,
        .input-card textarea:focus,
        .input-card select:focus {
            outline: none;
        }

        /* PARTY INFO */
        .party-info p {
            font-size: 14px; /* Increased font size */
            margin-bottom: 0.4rem; /* Adjusted margin */
            line-height: 1.6;
        }

        .party-info strong {
            color: var(--deep-green);
        }

        /* SERVICE & PRODUCT CARDS */
        .service-card,
        .product-card {
            background: #fdfdfb;
            border-radius: 16px;
            padding: 1.5rem 1.8rem; /* Increased padding */
            margin-bottom: 1.8rem; /* Increased margin */
            box-shadow: 0 6px 20px rgba(212, 185, 142, 0.1);
            border: 1px solid rgba(212, 185, 142, 0.15);
        }

        .editable-area {
            min-height: 70px; /* Increased min-height */
            line-height: 1.7; /* Increased line-height */
            font-size: 15px; /* Increased font size */
        }

        .editable-area ul {
            padding-left: 1.2rem;
            list-style: none;
        }

        .editable-area li {
            position: relative;
            padding-left: 1.2rem;
            margin-bottom: 0.5rem; /* Adjusted margin */
        }

        .editable-area li::before {
            content: '✓';
            color: var(--soft-gold);
            position: absolute;
            left: 0;
            font-weight: 600;
        }

        .editable-area:focus {
            outline: none;
        }

        /* COST SECTION */
        .cost-section {
            margin-top: 1.2rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0; /* Increased padding */
            border-bottom: 1px solid #f0f0f0;
            font-size: 15px; /* Increased font size */
        }

        .cost-row.label {
            font-weight: 600;
            color: var(--deep-green);
            font-size: 16px; /* Increased font size */
            padding-top: 0;
            border-bottom: 2px solid var(--soft-gold);
        }

        .cost-row input {
            text-align: right;
            font-weight: 500;
            font-size: 17px; /* Increased font size */
            border: none;
            background: transparent;
            width: 180px;
            color: var(--deep-green);
        }

        #remaining-balance-row {
            margin-top: 1.8rem; /* Increased margin */
            padding: 1.2rem 0; /* Increased padding */
            border-top: 2px solid var(--soft-gold);
            font-weight: 700;
            font-size: 17px; /* Increased font size */
        }

        #remaining-balance {
            font-family: 'Playfair Display', serif;
            font-size: 28px; /* Increased font size */
            color: var(--deep-green);
            text-align: right;
        }

        .remaining-note {
            text-align: right;
            font-style: italic;
            font-size: 14px; /* Increased font size */
            color: #777;
            margin-top: 0.4rem; /* Adjusted margin */
        }

        /* BANK INFO */
        .bank-box {
            background: #f9f7f4;
            border: 1px dashed #ddd;
            border-radius: 12px;
            padding: 1.2rem 1.5rem; /* Increased padding */
            margin-top: 1.8rem; /* Increased margin */
            font-size: 13.5px; /* Increased font size */
            line-height: 1.7; /* Increased line-height */
            color: #555;
        }

        .bank-box p {
            margin-bottom: 0.3rem; /* Adjusted margin */
        }

        .bank-box strong {
            color: var(--deep-green);
        }

        /* TERMS */
        .terms ul {
            list-style: none;
            padding-left: 0;
            font-size: 14.5px; /* Increased font size */
            line-height: 1.8; /* Increased line-height */
        }

        .terms li {
            position: relative;
            padding-left: 1.8rem; /* Increased padding */
            margin-bottom: 0.8rem; /* Increased margin */
        }

        .terms li::before {
            content: '•';
            color: var(--soft-gold);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* SIGNATURE */
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-top: 2rem; /* Tweaked */
        }

        .signature-block {
            text-align: center;
        }

        .script-title {
            font-family: 'Dancing Script', cursive;
            font-size: 22px; /* Tweaked */
            color: var(--soft-gold);
            margin-bottom: 1rem;
        }

        .signature-block p {
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 13.5px; /* Tweaked */
        }

        .signature-placeholder {
            margin-top: 2.5rem; /* Tweaked */
            height: 40px;
            border-bottom: 1.5px dashed #ccc;
            display: inline-block;
            width: 70%;
            font-style: italic;
            color: #aaa;
            font-size: 12px; /* Tweaked */
            line-height: 40px;
        }

        .editable-signature {
            display: inline-block;
            min-width: 180px;
            border-bottom: 1.5px dashed #ccc;
            padding: 0.4rem 0;
            font-family: 'Dancing Script', cursive;
            font-size: 22px;
            color: var(--deep-green);
        }

        .editable-signature:focus {
            outline: none;
            border-color: var(--soft-gold);
            border-style: solid;
        }

        /* ACTIONS */
        .actions {
            padding: 1.5rem 2.5rem; /* Tweaked */
            background: var(--cream);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 0.8rem 1.6rem;
            border-radius: 30px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1.5px solid transparent;
        }

        #print-btn, #capture-btn {
            background: var(--deep-green);
            color: white;
        }

        #print-btn:hover, #capture-btn:hover {
            background: #0f2a1e;
            transform: translateY(-1px);
        }

        #save-draft-btn, #new-contract-btn {
            background: transparent;
            color: var(--deep-green);
            border-color: var(--soft-gold);
        }

        #save-draft-btn:hover, #new-contract-btn:hover {
            background: var(--soft-gold);
            color: var(--charcoal);
        }

        /* CONTRACT MANAGEMENT */
        .contract-management {
            margin-top: 2rem;
            background: var(--white);
            padding: 1.8rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }

        #contract-list {
            max-height: 200px;
            height: auto;
            overflow-y: auto;
            margin: 1rem 0;
            padding-right: 0.5rem;
            list-style: none;
        }

        #contract-list li {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            margin-bottom: 0.5rem;
            border: 1px solid var(--light-gray);
        }

        #contract-list li:hover {
            background: #f5f2ed;
        }

        #contract-list li span {
            flex-grow: 1;
            font-weight: 500;
            color: var(--charcoal);
        }

        #contract-list li .contract-actions {
            display: flex;
            gap: 0.5rem;
        }

        #contract-list li .contract-actions button {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--soft-gold);
            background: transparent;
            color: var(--deep-green);
            transition: all 0.2s;
        }

        #contract-list li .contract-actions button:hover {
            background: var(--soft-gold);
            color: var(--white);
        }

        /* TIME PICKER COMPACT */
        .time-picker-compact {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .time-picker-compact input[type="time"] {
            flex: 1;
            min-width: 120px;
        }

        .time-picker-compact input[type="date"] {
            flex: 1;
            min-width: 160px;
        }

        /* SERVICE PRODUCT ROW */
        .service-product-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .service-product-col h4 {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            color: var(--deep-green);
            margin-bottom: 0.8rem;
            padding-left: 1rem;
            position: relative;
        }

        .service-product-col h4::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 1.4em;
            background-color: var(--soft-gold);
            border-radius: 2px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .two-column, .signature-section, .service-product-row {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            #contract-content { padding: 2rem; }
            .actions { flex-direction: column; gap: 1rem; }
            .time-picker-compact { flex-direction: column; align-items: stretch; }
        }

        .terms-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .terms-options .input-card {
            margin-bottom: 0;
            flex-grow: 1;
        }
        .terms-options .input-card label {
            cursor: pointer;
        }
        .terms-options .input-card input[type="radio"] {
            display: none;
        }
        .terms-options .input-card input[type="radio"]:checked + label {
            background-color: var(--deep-green);
            color: var(--white);
            border-color: var(--deep-green);
        }

        /* PRINT STYLES */
        @page { size: A4; margin: 12mm; }

        @media print {
            .terms-options {
                display: none;
            }
            body, .page-container, .container { margin: 0; padding: 0; box-shadow: none; background: white; }
            #contract-content { padding: 2rem; }
            .actions, .contract-management { display: none !important; }
            .section-title { font-size: 14pt; }
            .input-card, .service-card, .product-card, .bank-box { box-shadow: none; border: 1px solid #eee; }
            #remaining-balance { font-size: 20pt; }
            .gold-divider { background: var(--soft-gold); }
        }
    </style>
</head>
<body>
<div class="page-container">
    <div class="container">
        <div id="contract-content">
            <header>
                <h1 class="studio-name">KOOL D. STUDIO</h1>
                <p class="tagline">Art of Your Story</p>
                <div class="gold-divider"></div>
                <p class="contract-meta">HỢP ĐỒNG DỊCH VỤ</p>
                <p class="contract-meta">Ngày: <span id="contract-date"></span></p>
            </header>

            <main>
                <!-- PARTY INFO -->
                <section class="two-column">
                    <div>
                        <h3 class="section-title">Bên A: Khách Hàng</h3>
                        <div class="input-card">
                            <label>Tên khách hàng</label>
                            <input type="text" id="customer-name">
                        </div>
                        <div class="input-card">
                            <label>Số điện thoại</label>
                            <input type="tel" id="customer-phone">
                        </div>
                        <div class="input-card">
                            <div class="input-group">
                                <label>Ngày thực hiện dịch vụ</label>
                                <div id="appointment-display" style="font-size: 15px; color: var(--deep-green); font-weight: 500;"></div>
                            </div>
                            <div class="time-picker-compact">
                                <input type="time" id="appointment-time">
                                <input type="date" id="appointment-date">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="section-title">Bên B: Kool D. Studio</h3>
                        <div class="input-card">
                            <label>Đại diện</label>
                            <input type="text" id="studio-rep">
                        </div>
                        <div class="input-card">
                            <label>ĐT</label>
                            <input type="text" id="studio-phone" value="0379031662 - 0976839250">
                        </div>
                        <div class="input-card">
                            <label>Địa điểm thực hiện</label>
                            <input type="text" id="location" value="Trong studio">
                        </div>
                        <div class="party-info">
                            <p>www.kooldstudio.com</p>
                        </div>
                    </div>
                </section>

                <!-- SERVICE & PRODUCTS IN SEPARATE ROW -->
                <section>
                    <h3 class="section-title">Gói Dịch Vụ || Sản Phẩm Kèm Theo</h3>
                    <div class="service-product-row">
                        <div class="service-product-col">
                            <h4>Gói Dịch Vụ</h4>
                            <div class="service-card">
                                <div class="editable-area" id="service-details" contenteditable="true">
                                    <ul><li>Gói chụp, thời gian, địa điểm...</li></ul>
                                </div>
                            </div>
                        </div>
                        <div class="service-product-col">
                            <h4>Sản Phẩm Kèm Theo</h4>
                            <div class="product-card">
                                <div class="editable-area" id="included-products" contenteditable="true">
                                    <ul><li>Album, ảnh lớn, file ảnh...</li></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- COST & PAYMENT -->
                <section class="two-column">
                    <div>
                        <h3 class="section-title">Chi Phí & Thanh Toán</h3>
                        <div class="cost-section">
                            <div class="cost-row label">
                                <span>TỔNG CHI PHÍ (VNĐ)</span>
                                <input type="text" class="currency-input" id="total-cost" placeholder="0">
                            </div>
                            <div class="cost-row">
                                <span>Đặt cọc lần 1</span>
                                <input type="text" class="currency-input" id="deposit-1" placeholder="0">
                            </div>
                            <div class="cost-row">
                                <span>Thanh toán lần 2</span>
                                <input type="text" class="currency-input" id="deposit-2" placeholder="0">
                            </div>
                            <div id="remaining-balance-row" class="cost-row">
                                <span>SỐ DƯ CÒN LẠI</span>
                                <div style="text-align: right;">
                                    <div id="remaining-balance">0 VNĐ</div>
                                    <textarea id="remaining-note" class="remaining-note" placeholder="Ghi chú (vd: thanh toán khi nhận ảnh)" rows="1"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="section-title">Số tài khoản</h3>
                        <div class="bank-box" style="margin-top: 0;">
                            <p><strong>Vietcombank</strong> </p>
                            <p><strong>Trần Như Tuấn</strong></p>
                            <p><strong> 0071000763310</strong></p>
                            <p><strong>Nội dung:</strong> Tên khách hàng</p>
                        </div>
                    </div>
                </section>

                <!-- TERMS -->
                <section class="terms">
                    <h3 class="section-title">Điều Khoản Chung</h3>
                    <div class="terms-options">
                        <div class="input-card">
                            <input type="radio" id="terms-photo-radio" name="terms-type" value="photo" checked>
                            <label for="terms-photo-radio">Gói chụp ảnh</label>
                        </div>
                        <div class="input-card">
                            <input type="radio" id="terms-makeup-radio" name="terms-type" value="makeup">
                            <label for="terms-makeup-radio">Gói makeup</label>
                        </div>
                    </div>

                    <ul id="terms-photo">
                        <li>Studio giao ảnh gốc trong 48h, ảnh chỉnh sửa (file mềm) trong 15 ngày làm việc kể từ khi Khách hàng chốt list. Album/in ấn hoàn thiện trong 25-30 ngày làm việc.</li>

                        <li>Studio có thể sử dụng một số hình ảnh để quảng bá. Nếu yêu cầu riêng tư 100%, vui lòng thông báo trước.</li>

                        <li>Hủy hợp đồng: đặt cọc lần 1 không hoàn lại. Hoãn lịch 1 lần miễn phí (thông báo trước 7 ngày), lần 2 trở đi phí 10% giá trị hợp đồng.</li>

                        <li>Dịch vụ ngoài hợp đồng thanh toán 100% ngay. Giao sản phẩm tại studio; nếu giao tận nơi, Khách chịu phí & rủi ro vận chuyển.</li>
                    </ul>
                    <ul id="terms-makeup" style="display: none;">
                        <li>Thời Gian,Khách hàng vui lòng đúng giờ hẹn. Trễ hơn 30 phút không thông báo: Studio có quyền điều chỉnh quy trình hoặc hủy dịch vụ (áp dụng phí hủy).</li>
                        <li>Trách Nhiệm Cơ Địa,Khách hàng cần thông báo về mọi dị ứng/tình trạng da nhạy cảm trước khi làm dịch vụ. Studio miễn trừ trách nhiệm nếu xảy ra phản ứng do cơ địa mà không được thông báo.</li>
                        <li>Thử Mẫu (Cô Dâu),Phí thử mẫu là không hoàn lại. Yêu cầu thực hiện ít nhất 10 ngày trước ngày chính thức.</li>
                        <li>Hủy Hợp Đồng,Đặt cọc không hoàn lại (theo Điều Khoản Chung).</li>
                        <li>Hoãn Lịch,Hoãn miễn phí 1 lần khi báo trước 7 ngày làm việc. Báo trước 3-6 ngày tính phí 10%. Báo trước &lt;48 giờ tính phí 30% giá trị hợp đồng.</li>
                    </ul>
                </section>

                <!-- SIGNATURE -->
                <section class="signature-section">
                    <div class="signature-block">
                        <div class="script-title">Signature</div>
                        <p>ĐẠI DIỆN KHÁCH HÀNG</p>
                        <div class="signature-placeholder">(Ký và ghi rõ họ tên)</div>
                    </div>
                    <div class="signature-block">
                        <div class="script-title">Signature</div>
                        <p>ĐẠI DIỆN STUDIO</p>
                        <span class="editable-signature" contenteditable="true"></span>
                        <div class="signature-placeholder">(Ký và ghi rõ họ tên)</div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    </div>
    <div class="contract-management">
        <h3 class="section-title">Quản lý Hợp đồng</h3>
        <div class="input-card">
            <label for="contract-name-input">Tên Hợp đồng (SEO-friendly)</label>
            <input type="text" id="contract-name-input" placeholder="Nhập tên hợp đồng (vd: HopDongAnhCuoi_NguyenVanA)">
        </div>
        <div class="input-card">
            <label for="contract-notes-input">Ghi chú</label>
            <textarea id="contract-notes-input" rows="2" placeholder="Ghi chú về hợp đồng này"></textarea>
        </div>
        <div class="actions-management">
            <button class="btn" id="save-contract-btn">Lưu Hợp đồng</button>
            <button class="btn" id="load-contract-btn">Tải Hợp đồng</button>
            <button class="btn" id="delete-contract-btn">Xóa Hợp đồng</button>
            <button class="btn" id="capture-screenshot-btn">Chụp Màn hình</button>
            <button class="btn" id="export-pdf-btn">Xuất PDF</button>
        </div>

        <h4 class="section-title" style="margin-top: 2rem;">Lịch sử Hợp đồng</h4>
        <ul id="contract-list">
            <!-- Saved contracts will be loaded here -->
        </ul>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const els = {
            date: document.getElementById('contract-date'),
            customerName: document.getElementById('customer-name'),
            customerPhone: document.getElementById('customer-phone'),
            appointmentTime: document.getElementById('appointment-time'),
            appointmentDate: document.getElementById('appointment-date'),
            appointmentDisplay: document.getElementById('appointment-display'),
            studioRep: document.getElementById('studio-rep'),
            studioPhone: document.getElementById('studio-phone'),
            location: document.getElementById('location'),
            service: document.getElementById('service-details'),
            products: document.getElementById('included-products'),
            total: document.getElementById('total-cost'),
            deposit1: document.getElementById('deposit-1'),
            deposit2: document.getElementById('deposit-2'),
            remaining: document.getElementById('remaining-balance'),
            remainingNote: document.getElementById('remaining-note'),
            signature: document.querySelector('.editable-signature'),
            termsPhotoRadio: document.getElementById('terms-photo-radio'),
            termsMakeupRadio: document.getElementById('terms-makeup-radio'),

            // Contract management
            contractNameInput: document.getElementById('contract-name-input'),
            contractNotesInput: document.getElementById('contract-notes-input'),
            saveContractBtn: document.getElementById('save-contract-btn'),
            loadContractBtn: document.getElementById('load-contract-btn'),
            deleteContractBtn: document.getElementById('delete-contract-btn'),
            captureScreenshotBtn: document.getElementById('capture-screenshot-btn'),
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            contractList: document.getElementById('contract-list'),
        };

        function setDate() {
            const d = new Date();
            els.date.textContent = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            autoGenerateContractName();
        }

        function autoGenerateContractName() {
            const customerName = els.customerName.value.trim();
            const contractDate = els.date.textContent.replace(/\//g, '-');

            if (!customerName) {
                els.contractNameInput.value = '';
                return;
            }

            const slug = customerName
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/đ/g, 'd').replace(/Đ/g, 'D')
                .replace(/[^a-zA-Z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '_');

            els.contractNameInput.value = `HD_${slug}_${contractDate}`;
        }

        function format(v) { return v ? new Intl.NumberFormat('vi-VN').format(v) : ''; }
        function parse(v) { return parseFloat(String(v).replace(/\./g, '')) || 0; }

        function calc() {
            const t = parse(els.total.value);
            const d1 = parse(els.deposit1.value);
            const d2 = parse(els.deposit2.value);
            els.remaining.textContent = format(t - d1 - d2) + ' VNĐ';
        }

        document.querySelectorAll('.currency-input').forEach(input => {
            input.addEventListener('input', e => {
                let val = e.target.value.replace(/\D/g, '');
                e.target.value = format(val);
                calc();
            });
        });

        // Auto-grow textarea
        document.querySelectorAll('textarea').forEach(t => {
            t.addEventListener('input', () => {
                t.style.height = 'auto';
                t.style.height = t.scrollHeight + 'px';
            });
        });

        // Auto-detect period and format display in Vietnamese
        function updateAppointmentDisplay() {
            const time = els.appointmentTime.value;
            const date = els.appointmentDate.value;

            if (!time && !date) {
                els.appointmentDisplay.textContent = '';
                return;
            }

            let display = '';
            if (time) {
                const [h, m] = time.split(':').map(Number);
                const hour = h;
                let period = '';
                if (hour >= 5 && hour < 12) period = 'Sáng';
                else if (hour >= 12 && hour < 18) period = 'Chiều';
                else period = 'Tối';

                display += `${period} ${hour}h${m ? m + 'p' : ''} `;
            }
            if (date) {
                const d = new Date(date + 'T00:00:00');
                display += `ngày ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            }

            els.appointmentDisplay.textContent = display.trim() || '(Chưa chọn đầy đủ)';
        }

        [els.appointmentTime, els.appointmentDate].forEach(el => {
            el.addEventListener('change', updateAppointmentDisplay);
            el.addEventListener('input', updateAppointmentDisplay);
        });

        // --- Contract Management Functions ---
        function getContractData() {
            return {
                customerName: els.customerName.value,
                customerPhone: els.customerPhone.value,
                appointmentTime: els.appointmentTime.value,
                appointmentDate: els.appointmentDate.value,
                studioRep: els.studioRep.value,
                studioPhone: els.studioPhone.value,
                location: els.location.value,
                serviceDetails: els.service.innerHTML,
                includedProducts: els.products.innerHTML,
                totalCost: els.total.value,
                deposit1: els.deposit1.value,
                deposit2: els.deposit2.value,
                remainingNote: els.remainingNote.value,
                signature: els.signature.textContent,
                contractDate: els.date.textContent,
                termsType: els.termsPhotoRadio.checked ? 'photo' : 'makeup',
            };
        }

        function setContractData(data) {
            els.customerName.value = data.customerName || '';
            els.customerPhone.value = data.customerPhone || '';
            els.appointmentTime.value = data.appointmentTime || '';
            els.appointmentDate.value = data.appointmentDate || '';
            els.studioRep.value = data.studioRep || '';
            els.studioPhone.value = data.studioPhone || '0379031662 - 0976839250';
            els.location.value = data.location || 'Trong studio';
            els.service.innerHTML = data.serviceDetails || '<ul><li>Gói chụp, thời gian, địa điểm...</li></ul>';
            els.products.innerHTML = data.includedProducts || '<ul><li>Album, ảnh lớn, file ảnh...</li></ul>';
            els.total.value = data.totalCost || '';
            els.deposit1.value = data.deposit1 || '';
            els.deposit2.value = data.deposit2 || '';
            els.remainingNote.value = data.remainingNote || '';
            els.signature.textContent = data.signature || '';
            els.date.textContent = data.contractDate || setDate();

            if (data.termsType === 'makeup') {
                els.termsMakeupRadio.checked = true;
                document.getElementById('terms-makeup').style.display = 'block';
                document.getElementById('terms-photo').style.display = 'none';
            } else {
                els.termsPhotoRadio.checked = true;
                document.getElementById('terms-photo').style.display = 'block';
                document.getElementById('terms-makeup').style.display = 'none';
            }

            document.querySelectorAll('textarea').forEach(t => {
                t.style.height = 'auto';
                t.style.height = t.scrollHeight + 'px';
            });
            updateAppointmentDisplay();
            calc();
        }

        function saveContract() {
            const contractName = els.contractNameInput.value.trim();
            if (!contractName) {
                alert('Vui lòng nhập tên hợp đồng để lưu!');
                return;
            }

            const contractData = getContractData();
            const contractNotes = els.contractNotesInput.value.trim();

            const savedContract = {
                data: contractData,
                notes: contractNotes,
                timestamp: new Date().toLocaleString('vi-VN'),
            };

            try {
                localStorage.setItem(`contract_${contractName}`, JSON.stringify(savedContract));
                alert(`Hợp đồng "${contractName}" đã được lưu thành công!`);
                renderContractList();
            } catch (e) {
                alert('Lỗi khi lưu hợp đồng: ' + e.message);
            }
        }

        function loadContract(contractName) {
            try {
                const savedContract = localStorage.getItem(`contract_${contractName}`);
                if (savedContract) {
                    const parsedContract = JSON.parse(savedContract);
                    setContractData(parsedContract.data);
                    els.contractNameInput.value = contractName;
                    els.contractNotesInput.value = parsedContract.notes || '';
                    alert(`Hợp đồng "${contractName}" đã được tải.`);
                } else {
                    alert('Không tìm thấy hợp đồng này.');
                }
            } catch (e) {
                alert('Lỗi khi tải hợp đồng: ' + e.message);
            }
        }

        function deleteContract(contractName) {
            if (confirm(`Bạn có chắc chắn muốn xóa hợp đồng "${contractName}"?`)) {
                try {
                    localStorage.removeItem(`contract_${contractName}`);
                    alert(`Hợp đồng "${contractName}" đã được xóa.`);
                    renderContractList();
                    if (els.contractNameInput.value === contractName) {
                        clearCurrentContract();
                    }
                } catch (e) {
                    alert('Lỗi khi xóa hợp đồng: ' + e.message);
                }
            }
        }

        function clearCurrentContract() {
            els.customerName.value = '';
            els.customerPhone.value = '';
            els.appointmentTime.value = '';
            els.appointmentDate.value = '';
            els.studioRep.value = '';
            els.studioPhone.value = '0379031662 - 0976839250';
            els.location.value = 'Trong studio';
            els.service.innerHTML = '<ul><li>Gói chụp, thời gian, địa điểm...</li></ul>';
            els.products.innerHTML = '<ul><li>Album, ảnh lớn, file ảnh...</li></ul>';
            els.total.value = '';
            els.deposit1.value = '';
            els.deposit2.value = '';
            els.remainingNote.value = '';
            els.signature.textContent = '';
            els.contractNameInput.value = '';
            els.contractNotesInput.value = '';
            els.termsPhotoRadio.checked = true;
            document.getElementById('terms-photo').style.display = 'block';
            document.getElementById('terms-makeup').style.display = 'none';
            setDate();
            updateAppointmentDisplay();
            calc();
        }

        function renderContractList() {
            els.contractList.innerHTML = '';
            const contractKeys = Object.keys(localStorage).filter(key => key.startsWith('contract_'));

            if (contractKeys.length === 0) {
                els.contractList.innerHTML = '<li>Chưa có hợp đồng nào được lưu.</li>';
                return;
            }

            contractKeys.forEach(key => {
                const contractName = key.replace('contract_', '');
                const savedContract = JSON.parse(localStorage.getItem(key));
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>
                        <strong>${contractName}</strong>
                        <br>
                        <small>${savedContract.notes || 'Không có ghi chú'}</small>
                        <br>
                        <small>Lưu lúc: ${savedContract.timestamp}</small>
                    </span>
                    <div class="contract-actions">
                        <button data-action="load" data-name="${contractName}">Tải</button>
                        <button data-action="delete" data-name="${contractName}">Xóa</button>
                    </div>
                `;
                els.contractList.appendChild(listItem);
            });
        }

        async function captureScreenshot() {
            const contractContent = document.getElementById('contract-content');
            try {
                const canvas = await html2canvas(contractContent, { scale: 2 });
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `HopDong_${els.contractNameInput.value || 'Moi'}_${new Date().toISOString().slice(0,10)}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('Ảnh chụp màn hình đã được lưu!');
            } catch (e) {
                alert('Lỗi khi chụp màn hình: ' + e.message);
            }
        }

        async function exportPdf() {
            const contractContent = document.getElementById('contract-content');
            try {
                const canvas = await html2canvas(contractContent, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`HopDong_${els.contractNameInput.value || 'Moi'}_${new Date().toISOString().slice(0,10)}.pdf`);
                alert('Hợp đồng đã được xuất ra PDF!');
            } catch (e) {
                alert('Lỗi khi xuất PDF: ' + e.message);
            }
        }

        // Event Listeners
        els.customerName.addEventListener('input', autoGenerateContractName);
        els.saveContractBtn.addEventListener('click', saveContract);
        els.contractList.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON') {
                const action = target.dataset.action;
                const contractName = target.dataset.name;
                if (action === 'load') loadContract(contractName);
                else if (action === 'delete') deleteContract(contractName);
            }
        });

        els.captureScreenshotBtn.addEventListener('click', captureScreenshot);
        els.exportPdfBtn.addEventListener('click', exportPdf);

        const termsPhotoRadio = document.getElementById('terms-photo-radio');
        const termsMakeupRadio = document.getElementById('terms-makeup-radio');
        const termsPhoto = document.getElementById('terms-photo');
        const termsMakeup = document.getElementById('terms-makeup');

        termsPhotoRadio.addEventListener('change', () => {
            if (termsPhotoRadio.checked) {
                termsPhoto.style.display = 'block';
                termsMakeup.style.display = 'none';
            }
        });

        termsMakeupRadio.addEventListener('change', () => {
            if (termsMakeupRadio.checked) {
                termsPhoto.style.display = 'none';
                termsMakeup.style.display = 'block';
            }
        });

        // Initial setup
        setDate();
        calc();
        updateAppointmentDisplay();
        renderContractList();
    });
</script>
</body>
</html>